<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="map[name:Jack Collins]">
<meta name="description" content="Scenario Resolution   Scenario As part of my simple bash script to automate AMI creation in EC2, using AWS CLI, a call is made to the &amp;lsquo;special IP address&amp;rsquo; 169.254.169.254 to retrieve the Instance ID for the current EC2 server.
This Instance ID is required in the create-image command I am using, as below, but you may have your own scenarios for using metadata provided by 169.254.169.254.
aws ec2 create-image --instance-id $(curl -s http://169." />
<meta name="keywords" content="linux, red hat, rhel, pentest, pentester, ansible, automation, bash, python, linux, error resolution, aws" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="/articles/ec2_imdsv2/" />


    <title>
        
            AWS curl to 169.254.169.254 failing, 401 Unauthorized :: Jack Collins  â€” Linux Admin | Security | Automation | UK
        
    </title>





<link rel="stylesheet" href="/main.f65e09c8185054893957dfcdc776fa9ce9fc62f0b08aa061db93060f56459776.css" integrity="sha256-9l4JyBhQVIk5V9/Nx3b6nOn8YvCwiqBh25MGD1ZFl3Y=" crossorigin="anonymous">



    <link rel="apple-touch-icon" sizes="180x180" href="/favicon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="msapplication-TileColor" content="">


<meta itemprop="name" content="AWS curl to 169.254.169.254 failing, 401 Unauthorized">
<meta itemprop="description" content="Scenario Resolution   Scenario As part of my simple bash script to automate AMI creation in EC2, using AWS CLI, a call is made to the &lsquo;special IP address&rsquo; 169.254.169.254 to retrieve the Instance ID for the current EC2 server.
This Instance ID is required in the create-image command I am using, as below, but you may have your own scenarios for using metadata provided by 169.254.169.254.
aws ec2 create-image --instance-id $(curl -s http://169."><meta itemprop="datePublished" content="2024-01-31T01:00:00+01:00" />
<meta itemprop="dateModified" content="2024-01-31T01:00:00+01:00" />
<meta itemprop="wordCount" content="506"><meta itemprop="image" content="/images/profile_pic.png"/>
<meta itemprop="keywords" content="linux,error resolution,aws," />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="/images/profile_pic.png"/>

<meta name="twitter:title" content="AWS curl to 169.254.169.254 failing, 401 Unauthorized"/>
<meta name="twitter:description" content="Scenario Resolution   Scenario As part of my simple bash script to automate AMI creation in EC2, using AWS CLI, a call is made to the &lsquo;special IP address&rsquo; 169.254.169.254 to retrieve the Instance ID for the current EC2 server.
This Instance ID is required in the create-image command I am using, as below, but you may have your own scenarios for using metadata provided by 169.254.169.254.
aws ec2 create-image --instance-id $(curl -s http://169."/>



    <meta property="og:title" content="AWS curl to 169.254.169.254 failing, 401 Unauthorized" />
<meta property="og:description" content="Scenario Resolution   Scenario As part of my simple bash script to automate AMI creation in EC2, using AWS CLI, a call is made to the &lsquo;special IP address&rsquo; 169.254.169.254 to retrieve the Instance ID for the current EC2 server.
This Instance ID is required in the create-image command I am using, as below, but you may have your own scenarios for using metadata provided by 169.254.169.254.
aws ec2 create-image --instance-id $(curl -s http://169." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/articles/ec2_imdsv2/" /><meta property="og:image" content="/images/profile_pic.png"/><meta property="article:section" content="articles" />
<meta property="article:published_time" content="2024-01-31T01:00:00+01:00" />
<meta property="article:modified_time" content="2024-01-31T01:00:00+01:00" />







    <meta property="article:published_time" content="2024-01-31 01:00:00 &#43;0100 &#43;0100" />











    </head>

    
        <body>
    
    
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">&gt;</span>
            <span class="logo__text ">
                jackcollins.me.uk$ </span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="/articles">Articles</a></li><li><a href="/documents/CV_Jack_Collins_Linux_Admin_2023.pdf">Download CV</a></li><li><a href="/tags">Tags</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            
                <span class="theme-toggle not-selectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
   <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
   3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
   13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
 </svg></span>
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            
            </p>
        </div>

        <article>
            <h2 class="post-title"><a href="/articles/ec2_imdsv2/">AWS curl to 169.254.169.254 failing, 401 Unauthorized</a></h2>

            
            
            

            <div class="post-content">
                <ul>
<li><a href="#scenario">Scenario</a></li>
<li><a href="#resolution">Resolution</a></li>
</ul>
<hr>
<h3 id="scenario">Scenario</h3>
<p>As part of my simple bash script to automate AMI creation in EC2, using AWS CLI, a call is made to the &lsquo;special IP address&rsquo; 169.254.169.254 to retrieve the Instance ID for the current EC2 server.<br>
This Instance ID is required in the create-image command I am using, as below, but you may have your own scenarios for using metadata provided by 169.254.169.254.</p>
<pre tabindex="0"><code>aws ec2 create-image --instance-id $(curl -s http://169.254.169.254/latest/meta-data/instance-id) --name &quot;Test_Image&quot; --description &quot;This is a test&quot; --no-reboot
</code></pre><p>Recently, the above command stopped working. I narrowed the issue down to the curl request failing and therefore setting a blank variable.<br>
On running the curl command on it&rsquo;s own, with -v for verbosity, the following error was observed;</p>
<pre tabindex="0"><code>user@ec2server # curl -v http://169.254.169.254/latest/meta-data/instance-id
* About to connect() to 169.254.169.254 port 80 (#0)
*   Trying 169.254.169.254...
* Connected to 169.254.169.254 (169.254.169.254) port 80 (#0)
&gt; GET /latest/meta-data/instance-id HTTP/1.1
&gt; User-Agent: curl/7.29.0
&gt; Host: 169.254.169.254
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 401 Unauthorized
&lt; Content-Length: 0
&lt; Date: *
&lt; Server: EC2ws
&lt; Connection: close
&lt; Content-Type: text/plain
&lt;
* Closing connection 0
</code></pre><p>As you can see, a connection <em>is</em> successfully made, but is immediately closed with a 401 Unauthorized after attempting a GET.<br>
This points to what the problem is; <strong>the GET request is attempting to authenticate with a IMDSv2 token and create a session</strong>.<br>
We didn&rsquo;t give it a token, hence the failure.</p>
<hr>
<h3 id="resolution">Resolution</h3>
<p>Our issue stems from the fact that the command we used is for IMDSv1 (Instance Metadata Service), and the EC2 instance is configured to only accept IMDSv2.<br>
We can see this setting via the AWS Console; <strong>EC2 &gt; Instances &gt; Select an instance (tickbox) &gt; Actions &gt; Instance Settings &gt; Modify Instance Metadata Options</strong></p>
<p><img src="../../images/imds_setting.png" alt="A screenshot of the IMDS setting in the AWS console"></p>
<p>Setting IMDSv2 to Optional would resolve our issue, and allow the above command to run successfully.<br>
But we don&rsquo;t want to disable IMDSv2, as <a href="https://aws.amazon.com/blogs/security/get-the-full-benefits-of-imdsv2-and-disable-imdsv1-across-your-aws-infrastructure/">it&rsquo;s more secure than v1</a>. So, let&rsquo;s generate a session token and use that in our curl command instead.</p>
<pre tabindex="0"><code>TOKEN=`curl -X PUT http://169.254.169.254/latest/api/token -H &quot;X-aws-ec2-metadata-token-ttl-seconds: 600&quot;` &amp;&amp; curl -H &quot;X-aws-ec2-metadata-token: $TOKEN -v http://169.254.169.254/latest/meta-data/instance-id
</code></pre><p>And, with that, we now have success;</p>
<pre tabindex="0"><code>user@ec2server # TOKEN=`curl -X PUT http://169.254.169.254/latest/api/token -H &quot;X-aws-ec2-metadata-token-ttl-seconds: 600&quot;` &amp;&amp; curl -H &quot;X-aws-ec2-metadata-token: $TOKEN -v http://169.254.169.254/latest/meta-data/instance-id
* About to connect() to 169.254.169.254 port 80 (#0)
*   Trying 169.254.169.254...
* Connected to 169.254.169.254 (169.254.169.254) port 80 (#0)
&gt; GET /latest/meta-data/instance-id HTTP/1.1
&gt; User-Agent: curl/7.29.0
&gt; Host: 169.254.169.254
&gt; Accept: */*
&gt; X-aws-ec2-metadata-token: &lt;TOKEN APPEARS HERE&gt;
&gt;
&lt; HTTP/1.1 200 OK
&lt; X-Aws-Ec2-Metadata-Token-Ttl-Seconds: 600
&lt; Content-Type: text/plain
&lt; Accept-ranges: none
&lt; Last-Modified: *
&lt; Content-Length: 19
&lt; Date: *
&lt; Server: EC2ws
&lt; Connection: close

&lt;
* Closing connection 0

&lt;INSTANCE ID GIVEN HERE&gt;
</code></pre><p>Now we can use this successfully again, to automate creation of an EC2 AMI (a &lsquo;snapshot&rsquo; of the server, including all EBS volumes), for the current server;</p>
<pre tabindex="0"><code>aws ec2 create-image --instance-id$(TOKEN=`curl -X PUT http://169.254.169.254/latest/api/token -H &quot;X-aws-ec2-metadata-token-ttl-seconds: 600&quot;` &amp;&amp; curl -H &quot;X-aws-ec2-metadata-token: $TOKEN -v http://169.254.169.254/latest/meta-data/instance-id) --name &quot;automated_snapshot_$(date +%F-%H%M%S)_$(shuf -i 0-99999 -n 1)&quot; --description &quot;Image created from CLI&quot; --no-reboot
</code></pre><hr>
<p><a href="#top">Top of page</a></p>

            </div>
        </article>

        <hr />

        <div class="post-info">
            
    <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg>

        <span class="tag"><a href="/tags/linux/">linux</a></span>
        <span class="tag"><a href="/tags/error-resolution/">error resolution</a></span>
        <span class="tag"><a href="/tags/aws/">aws</a></span>
        
    </p>

            
  		</div>
    </main>

            </div>

            
                <footer class="footer">
    
    
    <div class="footer__inner">
        <div class="footer__content">
            <span>Created in Linux CLI using <a href="http://gohugo.io">Hugo</a></span><span>Self Hosted via Github and AWS Amplify</span><span><a href="/disclaimer">Disclaimer</a></span>
        </div>
    </div>
    
</footer>

            
        </div>

        



<script type="text/javascript" src="/bundle.min.644292943ae47eef02fcd64b11757aeb8caeeaebf473a823b62099edccac808e8d82689359f285e5d95994e5ad5ae3b9c1ccc281eb1828e67d0ba6630f95b832.js" integrity="sha512-ZEKSlDrkfu8C/NZLEXV664yu6uv0c6gjtiCZ7cysgI6NgmiTWfKF5dlZlOWtWuO5wczCgesYKOZ9C6ZjD5W4Mg==" crossorigin="anonymous"></script>



    </body>
</html>
